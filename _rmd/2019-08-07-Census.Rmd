---
layout: post  
title: Classifiació  
author: Josep Espluga  
published: true
status: process
draft: false  
tags: classificació  
---

Prediccio d'ingressos superiors/inferiors a $50k/any en funcio de les dades del cens.

***

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

# **Llibreries**

```{r}
library(tidyverse)
library(funModeling)
library(gmodels)
library(readr)
library(mice) # NA
library(ggthemes) #tableau
library(vcd) # assocstats Cramer-V
library(cowplot) # plot_grid
library(Rmisc) # CI
library(scales) # percent
library(skimr)
library(knitr)
library(kableExtra)
library(corrplot)
library(RColorBrewer)
library(minerva)
library(GGally) # plot_grid()
library(plotly)
library(writexl)
library(readxl)
library(caret)
library(tidymodels)
library(pROC)
```

# **Dades**

```{r}
adult <- read_csv("adult.csv", na="?")
head(adult)
```


```{r}
df_x <- adult

df_x %>% 
  # keep(is.numeric) %>% 
  map_df(~(data.frame(unics= n_distinct(.x),
                      classe= class(.x),
                      NA_q= sum(is.na(.x), na.rm = T),
                      zero_q= sum(.x == 0, na.rm = T)
  )
  ),
  .id= "variable") %>% 
  mutate(NA_p = percent(NA_q / nrow(df_x)),
         zero_p = percent(zero_q / nrow(df_x)),
         NA_q = cell_spec(NA_q, "html", color = ifelse(NA_q > 0, "white", "black"), background = ifelse(NA_q > 0, "red", "")),
         NA_p = cell_spec(NA_p, "html", color = ifelse(NA_p > 0.001, "white", "black"), background = ifelse(NA_p > 0.001, "red", "")),
         zero_q = cell_spec(zero_q, "html", color = ifelse(zero_q > 0.001, "white", "black"), background = ifelse(zero_q > 0.001, "orange", "")),
         zero_p = cell_spec(zero_p, "html", color = ifelse(zero_p > 0.001, "white", "black"), background = ifelse(zero_p > 0.001, "orange", "")),
         classe = cell_spec(classe, "html", color= ifelse(classe == "character", "blue", "")),
         unics = cell_spec(unics, align = "c")) %>% 
  select(1,3,2,4,6,5,7) %>% 
  arrange(classe) %>% 
  knitr::kable(format = "markdown") %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  add_header_above(c(" " = 1, " " = 1," " = 1, "NA" = 2, "ZERO" = 2))

```

NA: workclass, occupation, native.country.  
Dues variables amb elevada frequencia de zeros.Variables caracter possibles factors.  
capital.gain i capital.loss amb elevada frequencia de zeros.  
fnlwgt: alt valor d'unics.  
native.country: alta cardinalitat.  
education number i education: mateix nombre d'unics.  
Variables numeriques i caracter.  

```{r}

adult_m <- 
adult %>% 
  mutate_if(is.character, as.factor)

adult_n <- 
  adult %>% 
  keep(is.numeric)

adult_f <- 
  adult %>% 
  keep(is.factor)
  
```


# **Analisi NA**

```{r}
adult %>% 
  map_df(~sum(is.na(.x))) %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "q_na") %>% 
  # gather(key= "variable", value = "q_na") %>% 
  mutate(p_na= percent(q_na/nrow(adult))) %>% 
  arrange(desc(p_na)) %>% 
  filter(q_na > 0) %>% 
  kable(caption = "NA's", format = "markdown") %>% 
  kable_styling()
  
```

Occupation i workclass amb el mateix nombre de unics .  
Comprovem els NA de occupation que tenen workclass que son. 
1783 - 1863 = 7 individus.  
Tots 7 son "never-worked"  

```{r}
adult %>% 
  filter( is.na(occupation) & !is.na(workclass)) %>% 
  select(workclass)

```

Converisi? NA:
NA occupation: Altres.  
NA workclass: Altres.  
NA native.conutry: Altres.  

```{r}
adult_m <- 
  adult_m %>% 
  mutate(occupation = fct_explicit_na(occupation, na_level = "Altres"),
         workclass = fct_explicit_na(workclass, na_level = "Altres"),
         native.country = fct_explicit_na(native.country, na_level = "Altres"))
```

# **Analisi Univariant** 

## **Numeriques**

Estadistica Descriptiva:  

```{r}
options(scipen = 999)
adult %>% 
  keep(is.numeric) %>% 
  map_df(~(data.frame(mean = mean(.x),
                      sd= sd(.x),
                      mediana= median(.x),
                      max= max(.x),
                      min= min(.x),
                      zero_q= sum(.x==0, na.rm = T))),
        .id="variable") %>% 
  mutate(zero_p = percent(zero_q / nrow(df_x)),
         zero_q = cell_spec(zero_q, "html", color = ifelse(zero_q > 0.001, "white", "black"), background = ifelse(zero_q > 0.001, "orange", "")),
         zero_p = cell_spec(zero_p, "html", color = ifelse(zero_p > 0.001, "white", "black"), background = ifelse(zero_p > 0.001, "orange", ""))) %>% 
  # select(1,3,4,6,5,7,2) %>% 
  mutate_if(is.numeric, format, digits = 3, nsmall = 0, big.mark=',', small.interval = 3) %>% 
  kable(format = "markdown", caption = "Estadistica Descriptiva") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```

Histogrames:

```{r,census1, fig.height= 5, fig.width= 15, fig.align= "center"}
adult_n %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "valor") %>% 
  # gather() %>% 
  ggplot(aes(valor))+
    geom_histogram(bins = 20, fill = "steelblue3", color = "white")+
    theme_minimal()+
    facet_wrap(~variable, scales = 'free')+
    labs(x = "", y = "")
```

Grafics de densitat:

```{r,census2, fig.height= 5, fig.width= 15, fig.align= "center"}
adult_n %>% 
  pivot_longer(cols = everything(), names_to = "variable", values_to = "valor") %>% 
  # gather() %>%  
  ggplot(aes(x= valor, fill= variable))+
  #geom_histogram(aes( y= ..density..), fill = "steelblue3", color="white")+
  geom_density(fill = "steelblue3", alpha= 0.4)+
   theme_minimal()+
  facet_wrap(~variable, scales = "free")+
  labs(title = "", x="", y="")
```


### **Outliers**

Analisi grafic: 

```{r,census3, fig.height= 5, fig.width= 15, fig.align= "center"}
adult_n %>% 
  gather() %>% 
  ggplot(aes(factor(key), value))+
  geom_boxplot(fill = "steelblue3", alpha = 0.5)+
  theme_minimal()+
  facet_wrap(~key, scales = 'free')+
  labs(x = "", y = "")
```


Distribucio capital.gain i capital.loss consequencia elevat n. zeros.  
Capital.gain te un outlier diferenciat.  
Education.num te observacions amb baix nivell d'educacio.  

Descriptius:  

```{r}
options(scipen = 999)
adult %>% 
  keep(is.numeric) %>% 
  map_df(~(data.frame(q_25= quantile(.x, probs = 0.25),
                      q_75= quantile(.x, probs = 0.75),
                      iqr= IQR(.x),
                      n_out= length(boxplot(.x, plot = FALSE)$out))),
         .id="variable") %>% 
  mutate(p_out = percent(n_out / nrow(adult)),
         lo_wi= q_25 - (iqr * 1.5),
         up_wi= q_75 + (iqr * 1.5),
         lo_wi= ifelse(lo_wi < 0, 0, lo_wi)) %>% 
  mutate(p_out = cell_spec(p_out, "html", color = "red")) %>% 
  # select(1,3,4,6,5,7,2) %>% 
  kable(format = "markdown", caption = "Descriptius Outliers") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```
